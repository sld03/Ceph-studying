# Deploy RGW

# 1. Deploy Rados GW

Install radosgw with `apt install radosgw` on each node.

Create Keyring

```bash
sudo ceph auth get-or-create client.rgw.`hostname -s` osd 'allow rwx' mon 'allow rw' -o /var/lib/ceph/radosgw/ceph-rgw.`hostname -s`/keyring
```

![Untitled](Deploy%20RGW%200900b3e2b3f84292831928e3c0fa0032/Untitled.png)

Then add this to `/etc/ceph.conf` 

```bash
[client.rgw.n1]
host = n1
keyring = /var/lib/ceph/radosgw/ceph-rgw.n1/keyring
log file = /var/log/ceph/ceph-rgw-n1.log
rgw frontends = "beast endpoint=192.168.6.44:8080"
rgw thread pool size = 512
```

![Untitled](Deploy%20RGW%200900b3e2b3f84292831928e3c0fa0032/Untitled%201.png)

# 2. Multisite configuration for Ceph Object Gateway

## 2.1 Terminologies

### 2.1.1 Multizone

Each zone is equivalient to a **Ceph Cluster**

### 2.1.2 Multiple zonegroups

**Zonegroup** is previously called **region.**

Each zone group contain one or more zones.

If two zones are in the same zonegroup and that zonegroup is in the same realm as a second zonegroup, then the objects stored in the two zones share a global object namespace. This global object namespace ensures unique object IDs across zonegroups and zones.

### 2.1.3 Multiple Realms

Realms appears from Kraken release. 

Realm is a container for zonegroup.

Realm helps to set policies to multiple zonegroup.

Realms has a global unique namespace.

![Untitled](Deploy%20RGW%200900b3e2b3f84292831928e3c0fa0032/Untitled%202.png)

Configure site for rados gateway

`sudo radosgw-admin realm create --rgw-realm=eu-east --default`

Then create master zonegroup for the realm

```bash
sudo radosgw-admin zonegroup create --rgw-zonegroup=eu --endpoints=http://n1:8080,http://n2:8080,http://n3:8080 --rgw-realm=eu-east --master --default
```

Then create master zone for the zonegroup

```bash
sudo radosgw-admin zone create --rgw-zonegroup=eu --endpoints=http://n1:8080,http://n2:8080,http://n3:8080 --rgw-zone=eu-east --master --default
```

Delete all default pool, so the object will be stored in the new pool

```bash
sudo ceph osd pool delete default.rgw.control default.rgw.control --yes-i-really-really-mean-it
sudo ceph osd pool delete default.rgw.log default.rgw.log --yes-i-really-really-mean-it
sudo ceph osd pool delete default.rgw.meta default.rgw.meta --yes-i-really-really-mean-it
```

Create synchronization user for data synchronization

```bash
sudo radosgw-admin user create --uid="synchronization-user" --display-name="Synchronization User" --system
sudo radosgw-admin zone modify --rgw-zone=eu-east --access-key=9NNB6GYTK5Z8GDUORORH --secret=r7NR3YwciVzdlrS4eNuHwAfkLQ0cMFjj4LEJuBbv
sudo radosgw-admin period update --commitsudo radosgw-admin period update --commit
```

After that, restart rados gateway

```bash
sudo systemctl restart ceph-radosgw@rgw.`hostname -s`
```